<div class="p-8 bg-gray-50 min-h-screen">

  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-3xl font-bold text-gray-800">My Sessions</h2>
    <button 
      (click)="toggleCreateSession()"
      class="px-5 py-2.5 bg-blue-600 text-white font-medium rounded-full shadow-md hover:bg-blue-700 transition">
      + Create Session
    </button>
  </div>

  <!-- Create Session Form -->
  <div *ngIf="showCreateForm" class="bg-white shadow-md rounded-xl p-6 mb-6 max-w-md">
    <label class="block mb-2 text-gray-700 font-medium">Session Name</label>
    <input 
      type="text" 
      [(ngModel)]="newSessionName" 
      placeholder="Enter session name..."
      class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none mb-4"
    />
    <div class="flex justify-end space-x-3">
      <button (click)="createSession()" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">Create</button>
      <button (click)="toggleCreateSession()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg shadow hover:bg-gray-400 transition">Cancel</button>
    </div>
  </div>

  <!-- Loading & Error -->
  <div *ngIf="loading" class="text-gray-500 animate-pulse">Loading sessions...</div>
  <div *ngIf="error" class="text-red-500 font-medium">{{ error }}</div>

  <!-- Sessions Grid -->
  <div *ngIf="sessions.length > 0; else noSessions" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
    <div *ngFor="let session of sessions" class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition">

      <!-- Session Header -->
      <div class="flex justify-between items-center">
        <h3 class="text-xl font-semibold text-gray-900">{{ session.name }}</h3>
        <span class="text-xs text-gray-400">{{ session.createdAt | date }}</span>
        <button (click)="deleteSession(session.id)" class="px-2 py-1 text-sm bg-red-600 text-white rounded shadow hover:bg-red-700 transition">Delete</button>
      </div>

      <!-- Participants List -->
      <div class="mt-4">
        <h4 class="font-medium text-gray-700 mb-2">Participants</h4>
        <ul class="space-y-1 mb-4">
          <li *ngFor="let user of session.participants" class="flex justify-between items-center text-gray-600">
            <div class="flex items-center space-x-2">
              <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
              <span>{{ user.username }}</span>
            </div>
            <button (click)="removeParticipant(session.id, user.userId)" class="px-2 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700">Remove</button>
          </li>
        </ul>

        <!-- Add Friend Button -->
        <button (click)="toggleFriendMenu(session.id)" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition mb-3">
          Add a Friend
        </button>

        <!-- Friend Menu -->
        <div *ngIf="friendMenuOpen === session.id" class="mt-3 border rounded-lg bg-gray-50 p-3 shadow">
          <ul>
            <li *ngFor="let f of friends" class="flex justify-between items-center py-1">
              <span>{{ f.friendUsername }}</span>
              <button (click)="addFriendToSession(session.id, f.friendId)" class="px-2 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700">Add</button>
            </li>
          </ul>
        </div>

        <!-- Add Expense Button -->
        <button (click)="toggleExpenseForm(session.id)" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg shadow hover:bg-purple-700 transition mt-4">
          {{ expenseFormOpen === session.id ? 'Cancel' : 'Add Expense' }}
        </button>

        <!-- Expense Form -->
        <div *ngIf="expenseFormOpen === session.id" class="mt-4 border rounded-lg bg-gray-50 p-4 shadow">
          <input [(ngModel)]="newExpense.description" placeholder="Expense name" class="w-full mb-3 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" />
          <input [(ngModel)]="newExpense.totalAmount" type="number" placeholder="Amount" class="w-full mb-3 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" />
          <label class="flex items-center mb-3 space-x-2">
            <input type="checkbox" [(ngModel)]="newExpense.isEqualSplit" />
            <span class="text-gray-700">Split equally</span>
          </label>

          <!-- Custom Split -->
          <div *ngIf="!newExpense.isEqualSplit">
            <h4 class="text-gray-700 font-medium mb-2">Custom Split</h4>
            <div *ngFor="let p of session.participants" class="flex items-center justify-between mb-2">
              <span class="text-gray-600">{{ p.username }}</span>
              <input type="number" [(ngModel)]="customSplits[p.userId]" class="w-24 px-2 py-1 border rounded-lg focus:ring-2 focus:ring-purple-500" />
            </div>
          </div>

          <button (click)="createExpense(session.id)" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition mt-3">Save Expense</button>
        </div>

        <!-- Expenses List -->
        <div *ngIf="expenses[session.id]!.length > 0" class="mt-4">
          <h4 class="font-medium text-gray-700 mb-2">Expenses</h4>
          <ul class="space-y-2">
            <li *ngFor="let expense of expenses[session.id]" class="bg-gray-100 p-2 rounded-lg">
              <div class="flex justify-between">
                <span class="font-medium">{{ expense.description }}</span>
                <span class="text-gray-600">{{ expense.totalAmount | currency }}</span>
              </div>

              <!-- Paid by -->
              <div class="flex justify-between text-sm text-gray-500 mb-1">
                <span>Paid by: {{ getUsername(session, expense.paidById) }}</span>
              </div>

              <!-- Splits  -->
              <div *ngFor="let split of getSplitsForDisplay(expense, session)" class="ml-2 text-gray-700">
                 <span>{{ getUsername(session, split.userId) }} owes {{ split.amount | currency }} - {{ split.status === 0 ? 'Pending' : 'Settled' }}</span>
              </div>
            </li>
          </ul>
        </div>

      </div>
    </div>
  </div>

  <!-- No Sessions Template -->
  <ng-template #noSessions>
    <div class="flex flex-col items-center justify-center mt-20 text-gray-500">
      <p class="text-lg">You are not part of any sessions yet.</p>
    </div>
  </ng-template>
</div>
